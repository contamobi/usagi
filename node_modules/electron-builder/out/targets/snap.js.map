{
  "version": 3,
  "file": "snap.js",
  "sourceRoot": "",
  "sources": [
    "../../src/targets/snap.ts"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "import { LinuxTargetHelper } from \"./LinuxTargetHelper\"\nimport { LinuxPackager } from \"../linuxPackager\"\nimport { log } from \"electron-builder-util/out/log\"\nimport { SnapOptions } from \"../options/linuxOptions\"\nimport { emptyDir, outputFile, copy } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { safeDump } from \"js-yaml\"\nimport { spawn } from \"electron-builder-util\"\nimport { homedir } from \"os\"\nimport { Target, Arch, toLinuxArchString } from \"electron-builder-core\"\n\nexport default class SnapTarget extends Target {\n  private readonly options: SnapOptions = Object.assign({}, this.packager.platformSpecificBuildOptions, (<any>this.packager.config)[this.name])\n\n  constructor(name: string, private readonly packager: LinuxPackager, private readonly helper: LinuxTargetHelper, readonly outDir: string) {\n    super(name)\n  }\n\n  async build(appOutDir: string, arch: Arch): Promise<any> {\n    log(`Building Snap for arch ${Arch[arch]}`)\n\n    const packager = this.packager\n    const appInfo = packager.appInfo\n    const options = this.options\n\n    const stageDir = `${appOutDir}-snap`\n    const snapDir = path.join(stageDir, \"snap\")\n    await emptyDir(stageDir)\n\n    const extraSnapSourceDir = path.join(stageDir, \"extra\")\n    const isUseUbuntuPlatform = options.ubuntuAppPlatformContent != null\n    if (isUseUbuntuPlatform) {\n      // ubuntu-app-platform requires empty directory\n      await emptyDir(path.join(extraSnapSourceDir, \"ubuntu-app-platform\"))\n    }\n\n    const snap: any = {}\n    snap.name = packager.executableName\n    snap.version = appInfo.version\n    snap.summary = options.summary || appInfo.productName\n    snap.description = this.helper.getDescription(options)\n    snap.confinement = options.confinement || \"strict\"\n    snap.grade = options.grade || \"stable\"\n\n    await this.helper.icons\n    if (this.helper.maxIconPath != null) {\n      snap.icon = \"snap/gui/icon.png\"\n      await copy(this.helper.maxIconPath, path.join(snapDir, \"gui\", \"icon.png\"))\n    }\n\n    await this.helper.computeDesktopEntry(this.options, `${snap.name}`, path.join(snapDir, \"gui\", `${snap.name}.desktop`), {\n      \"Icon\": \"${SNAP}/meta/gui/icon.png\"\n    })\n\n    if (options.assumes != null) {\n      if (!Array.isArray(options.assumes)) {\n        throw new Error(\"snap.assumes must be an array of strings\")\n      }\n      snap.assumes = options.assumes\n    }\n\n    snap.apps = {\n      [snap.name]: {\n        command: `desktop-launch $SNAP/${packager.executableName}`,\n        plugs: replaceDefault(options.plugs, [\"home\", \"x11\", \"unity7\", \"browser-support\", \"network\", \"gsettings\", \"pulseaudio\", \"opengl\"])\n      }\n    }\n\n    if (isUseUbuntuPlatform) {\n      snap.apps[snap.name].plugs.push(\"platform\")\n      snap.plugs = {\n        platform: {\n          interface: \"content\",\n          content: \"ubuntu-app-platform1\",\n          target: \"ubuntu-app-platform\",\n          \"default-provider\": \"ubuntu-app-platform\",\n        }\n      }\n    }\n\n    // libxss1, libasound2, gconf2 - was \"error while loading shared libraries: libXss.so.1\" on Xubuntu 16.04\n    const isUseDocker = process.platform !== \"linux\"\n\n    const defaultStagePackages = (isUseUbuntuPlatform ? [\"libnss3\"] : [\"libnotify4\", \"libappindicator1\", \"libxtst6\", \"libnss3\", \"libxss1\", \"fontconfig-config\", \"gconf2\", \"libasound2\", \"pulseaudio\"])\n    snap.parts = {\n      app: {\n        plugin: \"dump\",\n        \"stage-packages\": replaceDefault(options.stagePackages, defaultStagePackages),\n        source: isUseDocker ? `/out/${path.basename(appOutDir)}` : appOutDir,\n        after: isUseUbuntuPlatform ? [\"extra\", \"desktop-ubuntu-app-platform\"] : [\"desktop-glib-only\"]\n      }\n    }\n\n    if (isUseUbuntuPlatform) {\n      snap.parts.extra = {\n        plugin: \"dump\",\n        source: isUseDocker ? `/out/${path.basename(stageDir)}/${path.basename(extraSnapSourceDir)}` : extraSnapSourceDir\n      }\n    }\n\n    if (packager.packagerOptions.effectiveOptionComputed != null && await packager.packagerOptions.effectiveOptionComputed(snap)) {\n      return\n    }\n\n    const snapcraft = path.join(snapDir, \"snapcraft.yaml\")\n    await outputFile(snapcraft, safeDump(snap, {lineWidth: 160}))\n\n    const snapName = `${snap.name}_${snap.version}_${toLinuxArchString(arch)}.snap`\n    const resultFile = path.join(this.outDir, snapName)\n\n    if (isUseDocker) {\n      await spawn(\"docker\", [\"run\", \"--rm\",\n        \"-v\", `${packager.info.projectDir}:/project`,\n        \"-v\", `${homedir()}/.electron:/root/.electron`,\n        // dist dir can be outside of project dir\n        \"-v\", `${this.outDir}:/out`,\n        \"electronuserland/electron-builder:latest\",\n        \"/bin/bash\", \"-c\", `snapcraft --version && cp -R /out/${path.basename(stageDir)} /s/ && cd /s && snapcraft snap --target-arch ${toLinuxArchString(arch)} -o /out/${snapName}`], {\n        cwd: packager.info.projectDir,\n        stdio: [\"ignore\", \"inherit\", \"inherit\"],\n      })\n    }\n    else {\n      await spawn(\"snapcraft\", [\"snap\", \"--target-arch\", toLinuxArchString(arch), \"-o\", resultFile], {\n        cwd: stageDir,\n        stdio: [\"ignore\", \"inherit\", \"pipe\"],\n      })\n    }\n    packager.dispatchArtifactCreated(resultFile, this)\n  }\n}\n\nfunction replaceDefault(inList: Array<string> | n, defaultList: Array<string>): Array<string> {\n  if (inList == null) {\n    return defaultList\n  }\n\n  const index = inList.indexOf(\"default\")\n  if (index >= 0) {\n    let list = inList.slice(0, index)\n    list.push(...defaultList)\n    if (index != (inList.length - 1)) {\n      list.push(...inList.slice(index + 1))\n    }\n    inList = list\n  }\n  return inList\n}"
  ]
}
